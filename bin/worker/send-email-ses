#!/usr/bin/perl
#
# send-email-ses -- worker for sending email through an SMTP server
#
# This worker receives TheSchwartz email jobs and converts them to
# DW::Task::SendEmail tasks for processing by the modern task system.
#
# Authors:
#      Mark Smith <mark@dreamwidth.org>
#
# Copyright (c) 2015 by Dreamwidth Studios, LLC.
#
# This program is free software; you may redistribute it and/or modify it under
# the same terms as Perl itself. For a copy of the license, please reference
# 'perldoc perlartistic' or 'perldoc perlgpl'.
#

use v5.10;
use strict;
BEGIN {
    require "$ENV{LJHOME}/cgi-bin/ljlib.pl";
}

use Carp qw/ croak /;
use LJ::Worker::TheSchwartz;

schwartz_decl('TheSchwartz::Worker::SendEmail');
schwartz_on_idle(sub {
    $0 = "send-email-ses [idle, $TheSchwartz::Worker::SendEmail::_COUNT, $TheSchwartz::Worker::SendEmail::_BAD]";
});
schwartz_work();

# ============================================================================
package TheSchwartz::Worker::SendEmail;
use base 'TheSchwartz::Worker';
use Carp qw/ croak /;

our $_COUNT = 0;
our $_BAD = 0;

sub work {
    my ( $class, $job ) = @_;
    my $args = $job->arg;

    # Convert TheSchwartz job to DW::Task::SendEmail task
    my $task = DW::Task::SendEmail->new($args);
    
    # Enqueue the task for processing by the task queue system
    my $result = DW::TaskQueue->dispatch($task);
    
    if ($result) {
        # Task was successfully enqueued, mark job as completed
        $job->completed;
        $_COUNT++;
        DW::Stats::increment( 'dw.email.sent', 1, [ "status:enqueued", "via:smtp" ] );
    } else {
        # Failed to enqueue task, retry the job
        $job->failed("Failed to enqueue email task, will retry");
    }
}

sub keep_exit_status_for { 0 }
sub grab_for { 500 }
sub max_retries { 5 * 24 }  # 5 days * 24 hours
sub retry_delay {
    my ($class, $fails) = @_;
    return ((5*60, 5*60, 15*60, 30*60)[$fails] || 3600);
}
